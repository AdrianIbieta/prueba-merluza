<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>VITAC – Merluza de Cola</title>
<style>
  :root { --cols: 7; --rows: 30; }
  * { box-sizing: border-box; }
  body, html { margin: 0; height: 100%; font-family: Arial, sans-serif; }
  #grid { display: grid; grid-template-columns: repeat(7, 1fr);
          grid-template-rows: repeat(30, 1fr); height: 100vh;
          gap: 4px; padding: 4px; background: #fafafa; }
  .cell { border: 1px solid #e0e0e0; }

  /* Logo */
  #logo { grid-column: 1 / 2; grid-row: 1 / 5; background: #004f9e;
          display: flex; align-items: center; justify-content: center;
          border-radius: 4px; overflow: hidden; }
  #logo img { max-width: 100%; max-height: 100%; object-fit: contain; }

  /* Selector */
  #selector { grid-column: 1 / 2; grid-row: 5 / 31; background: #f1f1f1;
               padding: 6px; overflow-y: auto; border-radius: 4px;
               display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
  #selector button { width: 100%; padding: 6px 4px; border: 1px solid #ccc;
                     background: #fff; cursor: pointer; border-radius: 3px;
                     transition: background 0.2s; font-size: 0.85rem; }
  #selector button:hover { background: #e8e8ff; }
  #selector button.active { background: #004f9e; color: #fff; }

  /* Chart container */
  #chartMcolaCont {
    grid-column: 2 / 4;
    grid-row: 1 / 14;
    background: #ffffff;
    padding: 8px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #chartMcola {
    width: 100%;
    height: 100%;
  }

  /* Info Panel */
  #infoPanel {
    grid-column: 2 / 4;
    grid-row: 14 / 16;
    background: #ffffff;
    border-radius: 4px;
    padding: 4px 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
  }
  .infoBox {
    display: flex;
    align-items: baseline;
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 3px;
    padding: 2px 4px;
    gap: 4px;
    white-space: nowrap;
  }
  .infoBox .label {
    font-weight: 700;
    margin: 0 2px 0 0;
  }
  .infoBox .value {
    font-size: 0.9rem;
    font-weight: 600;
  }

  /* Merluza del Sur chart container */
  #chartMsurCont {
    grid-column: 2 / 4;
    grid-row: 16 / 29;
    background: #ffffff;
    padding: 8px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #chartMsur {
    width: 100%;
    height: 100%;
  }

  /* Info Panel Merluza Sur */
  #infoPanelMsur {
    grid-column: 2 / 4;
    grid-row: 29 / 31;
    background: #ffffff;
    border-radius: 4px;
    padding: 4px 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
  }

  /* Donut Capturas */
  #donutCaptCont {
    grid-column: 4 / 6;   /* columnas 4 y 5 */
    grid-row: 1 / 23;     /* filas 1 a 22 */
    background: #ffffff;
    padding: 8px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #donutCapt {
    width: 100%;
    height: 100%;
  }

  /* Panel informativo del Lance */
  
  /* Panel informativo del Lance (nuevo estilo) */
  #panelLance {
    grid-column: 4 / 6;
    grid-row: 23 / 31;
    background: #ffffff;
    border-radius: 4px;
    padding: 8px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-size: 0.8rem;
  }
  .legend {
    display: flex;
    justify-content: center;
    gap: 12px;
    font-weight: 600;
  }
  .legend .sq {
    display: inline-block;
    width: 10px;
    height: 10px;
    margin-right: 4px;
  }
  .sq.mcola { background:#f28e2b; }
  .sq.msur { background:#4e79a7; }
  .sq.otros { background:#76b7b2; }

  .kgs {
    display: flex;
    justify-content: center;
    gap: 24px;
  }
  .kgBox {
    border: 1px solid #000;
    padding: 6px 16px;
    font-size: 1rem;
    font-weight: 700;
  }

  .meta {
    border-collapse: collapse;
    width: 100%;
    margin-top: 6px;
  }
  .meta th, .meta td {
    border: 1px solid #000;
    padding: 4px;
    text-align: center;
  }
  .meta th {
    background: #f0f0f0;
  }

  .lLabel { font-weight: 600; }
  #panelLance .total { margin-top:4px; border-top:1px solid #ddd; padding-top:4px; font-weight:700; }

  #mapLance{
    grid-column: 6 / 8;
    grid-row: 1 / 31;
    width: 100%;
    height: 100%;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <div id="grid">
    <div id="logo" class="cell">
      <img src="logo vitac.png" alt="Logo VITAC">
    </div>

    <div id="selector" class="cell"></div>

    <div id="chartMcolaCont" class="cell">
      <canvas id="chartMcola"></canvas>
    </div>
    <div id="infoPanel" class="cell">
      <div class="infoBox"><span class="label">MODA</span><span id="valModa" class="value">–</span></div>
      <div class="infoBox"><span class="label">FREC</span><span id="valFrec" class="value">–</span></div>
      <div class="infoBox"><span class="label">RANGO</span><span id="valRango" class="value">–</span></div>
      <div class="infoBox"><span class="label">TOTAL</span><span id="valTotal" class="value">–</span></div>
    </div>

  
  <div id="chartMsurCont" class="cell">
    <canvas id="chartMsur"></canvas>
  </div>

  <div id="infoPanelMsur" class="cell">
      <div class="infoBox"><span class="label">MODA</span><span id="valModaS" class="value">–</span></div>
      <div class="infoBox"><span class="label">FREC</span><span id="valFrecS" class="value">–</span></div>
      <div class="infoBox"><span class="label">RANGO</span><span id="valRangoS" class="value">–</span></div>
      <div class="infoBox"><span class="label">TOTAL</span><span id="valTotalS" class="value">–</span></div>
  </div>

    <div id="donutCaptCont" class="cell">
      <canvas id="donutCapt"></canvas>
    </div>

    
<div id="panelLance" class="cell">
  <div class="legend">
    <span><span class="sq mcola"></span> Merluza cola</span>
    <span><span class="sq msur"></span> Merluza sur</span>
    <span><span class="sq otros"></span> Otros</span>
  </div>
  <div class="kgs">
    <div class="kgBox"><span id="kgMcola">–</span> kg</div>
    <div class="kgBox"><span id="kgMsur">–</span> kg</div>
    <div class="kgBox"><span id="kgOtros">–</span> kg</div>
  </div>
  <table class="meta">
    <thead><tr><th>FECHA</th><th>LATITUD</th><th>LONGITUD</th></tr></thead>
    <tbody><tr><td id="metaFecha"></td><td id="metaLat"></td><td id="metaLon"></td></tr></tbody>
  </table>
</div>
    <div id="mapLance" class="cell"></div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

// --- Dynamic data loader injected ---
let lances, classes, dataByLance, dataMsur, dataCapt, lanceInfo, coordsLance;
function initVITAC(){

// Build selector
const selector = document.getElementById('selector');
lances.forEach(num => {
  const btn = document.createElement('button');
  btn.textContent = `Lance ${num}`;
  btn.dataset.lance = num;
  selector.appendChild(btn);
});

let chart;
function updateInfoPanel(lance) {
  const freqs = dataByLance[String(lance)];
  const total = freqs.reduce((a,b)=>a+b,0);
  const maxFreq = Math.max(...freqs);
  const modeIndex = freqs.indexOf(maxFreq);
  const moda = classes[modeIndex];
  const firstIdx = freqs.findIndex(f => f>0);
  const lastIdx = freqs.length - 1 - [...freqs].reverse().findIndex(f=>f>0);
  const rango = (firstIdx === -1) ? '–' : classes[firstIdx] + ' / ' + classes[lastIdx];

  document.getElementById('valModa').textContent = moda || '–';
  document.getElementById('valFrec').textContent = maxFreq || 0;
  document.getElementById('valRango').textContent = rango;
  document.getElementById('valTotal').textContent = total;
}


function drawChart(lance) {
  const ctx = document.getElementById('chartMcola').getContext('2d');
  const freqs = dataByLance[String(lance)];
  updateInfoPanel(lance);
  if(chart) {
    chart.data.datasets[0].data = freqs;
    chart.options.plugins.title.text = `Merluza de Cola – Lance ${lance}`;
    chart.update();
    return;
  }
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: classes,
      datasets: [{
        label: 'Frecuencia',
        data: freqs,
        fill: false,
        tension: 0.3,
        borderWidth: 2,
        pointRadius: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: `Merluza de Cola – Lance ${lance}`
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Frecuencia'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Talla (cm)'
          }
        }
      }
    }
  });
}

function setActiveButton(lance) {
  selector.querySelectorAll('button').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.lance == lance);
  });
}


/* ----- Donut Capturas ----- */
const dataCapt = {"1":[40.59,41.25,18.16],"2":[15.32,75.48,9.2],"3":[45.32,47.41,7.27],"4":[45.51,44.31,10.17],"5":[18.54,72.03,9.43],"6":[8.33,88.84,2.83],"7":[2.8,97.1,0.1],"8":[9.16,90.84,0.0],"9":[4.89,95.11,0.0],"10":[70.51,21.0,8.5],"11":[13.35,85.92,0.73],"12":[76.11,10.51,13.39],"13":[61.94,33.26,4.8],"14":[71.28,9.1,19.62],"15":[35.16,54.85,9.99],"16":[87.79,2.23,9.98],"17":[88.89,4.69,6.42],"18":[80.5,6.09,13.4],"19":[81.48,8.98,9.53],"20":[86.48,12.28,1.23],"21":[60.84,22.9,16.26],"22":[39.09,58.99,1.92],"23":[1.09,98.8,0.11],"24":[52.19,46.81,1.0],"25":[57.81,37.64,4.55],"26":[79.2,0.0,20.8],"27":[84.7,0.43,14.87],"28":[41.84,2.89,55.27],"29":[95.45,2.95,1.6],"30":[77.64,6.8,15.56],"31":[8.5,89.09,2.42],"32":[34.03,59.35,6.61],"33":[56.61,36.82,6.57],"34":[72.61,17.87,9.51],"35":[80.91,18.59,0.5],"36":[17.46,82.38,0.16]};

let chartDonut;
function drawDonut(lance) {
  const vals = dataCapt[lance] || dataCapt[String(lance)];
  if(!vals) return;
  const ctx = document.getElementById('donutCapt').getContext('2d');
  if(chartDonut) {
    chartDonut.data.datasets[0].data = vals;
    chartDonut.options.plugins.title.text = 'Capturas – Lance ' + lance;
    chartDonut.update();
    return;
  }
  chartDonut = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Merluza Sur','Merluza Cola','Otros'],
      datasets: [{
        data: vals,
        backgroundColor: ['#4e79a7','#f28e2b','#76b7b2'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' },
        title: { display: true, text: 'Capturas – Lance ' + lance }
      }
    }
  });
}

/* --- Panel informativo del Lance --- */
const lanceInfo = {"1":{"Fecha":"2024-08-07","Lat":"43\u00b030,8'S","Lon":"75\u00b013,3'W","Msur":75.5,"Mcola":76.8,"Otros":33.8},"2":{"Fecha":"07-08-2024","Lat":"43\u00b041,5'S","Lon":"75\u00b006,6'W","Msur":126.4,"Mcola":623.0,"Otros":75.9},"3":{"Fecha":"2024-08-08","Lat":"43\u00b046,1'S","Lon":"75\u00b002,0'W","Msur":102.5,"Mcola":107.2,"Otros":16.4},"4":{"Fecha":"2024-08-08","Lat":"43\u00b056,4'S","Lon":"75\u00b014,9'W","Msur":43.6,"Mcola":42.5,"Otros":9.8},"5":{"Fecha":"2024-08-08","Lat":"44\u00b000,4'S","Lon":"75\u00b014,1'W","Msur":97.3,"Mcola":378.0,"Otros":49.5},"6":{"Fecha":"2024-08-09","Lat":"44\u00b002,7'S","Lon":"75\u00b007,3'W","Msur":75.2,"Mcola":802.0,"Otros":25.6},"7":{"Fecha":"2024-08-09","Lat":"44\u00b005,3'S","Lon":"74\u00b056,9'W","Msur":116.2,"Mcola":4033.0,"Otros":4.2},"8":{"Fecha":"2024-08-09","Lat":"44\u00b007,6'S","Lon":"74\u00b059,8'W","Msur":370.1,"Mcola":3669.0,"Otros":0.0},"9":{"Fecha":"2024-08-10","Lat":"44\u00b011,3'S","Lon":"74\u00b053,9'W","Msur":142.0,"Mcola":2760.0,"Otros":0.0},"10":{"Fecha":"2024-08-10","Lat":"44\u00b013,5'S","Lon":"75\u00b006,0'W","Msur":207.9,"Mcola":61.9,"Otros":25.1},"11":{"Fecha":"2024-08-11","Lat":"44\u00b012,7'S","Lon":"74\u00b051,6'W","Msur":326.4,"Mcola":2100.0,"Otros":17.8},"12":{"Fecha":"2024-08-11","Lat":"44\u00b019,1'S","Lon":"75\u00b021,2'W","Msur":386.7,"Mcola":53.4,"Otros":68.0},"13":{"Fecha":"2024-08-12","Lat":"44\u00b024,7'S","Lon":"75\u00b020,3'W","Msur":353.8,"Mcola":190.0,"Otros":27.4},"14":{"Fecha":"2024-08-12","Lat":"44\u00b035,4'S","Lon":"75\u00b022,6'W","Msur":126.5,"Mcola":16.1,"Otros":34.8},"15":{"Fecha":"2024-08-12","Lat":"44\u00b039,7'S","Lon":"75\u00b021,3'W","Msur":48.5,"Mcola":75.7,"Otros":13.8},"16":{"Fecha":"2024-08-13","Lat":"44\u00b044,8'S","Lon":"75\u00b030,4'W","Msur":271.7,"Mcola":6.9,"Otros":30.9},"17":{"Fecha":"2024-08-13","Lat":"44\u00b051,6'S","Lon":"75\u00b032,3'W","Msur":266.9,"Mcola":14.1,"Otros":19.3},"18":{"Fecha":"2024-08-14","Lat":"45\u00b000,4'S","Lon":"75\u00b030,6'W","Msur":148.7,"Mcola":11.3,"Otros":24.8},"19":{"Fecha":"2024-08-15","Lat":"45\u00b020,4'S","Lon":"75\u00b031,8'W","Msur":64.6,"Mcola":7.1,"Otros":7.6},"20":{"Fecha":"2024-08-15","Lat":"45\u00b017,9'S","Lon":"75\u00b031,1'W","Msur":337.9,"Mcola":48.0,"Otros":4.8},"21":{"Fecha":"2024-08-16","Lat":"45\u00b012,6'S","Lon":"75\u00b008,9'W","Msur":209.0,"Mcola":78.7,"Otros":55.9},"22":{"Fecha":"2024-08-16","Lat":"45\u00b008,1'S","Lon":"75\u00b022,7'W","Msur":171.6,"Mcola":259.0,"Otros":8.4},"23":{"Fecha":"2024-08-16","Lat":"45\u00b021,6'S","Lon":"75\u00b004,0'W","Msur":47.0,"Mcola":4256.0,"Otros":4.7},"24":{"Fecha":"2024-08-17","Lat":"45\u00b009,9'S","Lon":"75\u00b008,3'W","Msur":268.7,"Mcola":241.0,"Otros":5.1},"25":{"Fecha":"2024-08-17","Lat":"45\u00b004,0'S","Lon":"75\u00b016,7'W","Msur":97.2,"Mcola":63.3,"Otros":7.7},"26":{"Fecha":"2024-08-19","Lat":"45\u00b029,4'S","Lon":"75\u00b030,6'W","Msur":30.4,"Mcola":0.0,"Otros":8.0},"27":{"Fecha":"2024-08-19","Lat":"45\u00b035,0'S","Lon":"75\u00b031,6'W","Msur":55.8,"Mcola":0.3,"Otros":9.8},"28":{"Fecha":"2024-08-20","Lat":"45\u00b046,0'S","Lon":"75\u00b033,6'W","Msur":53.5,"Mcola":3.7,"Otros":70.7},"29":{"Fecha":"2024-08-20","Lat":"45\u00b055,3'S","Lon":"75\u00b033,9'W","Msur":661.9,"Mcola":20.5,"Otros":11.1},"30":{"Fecha":"2024-08-21","Lat":"46\u00b008,4'S","Lon":"75\u00b030,6'W","Msur":117.0,"Mcola":10.2,"Otros":23.4},"31":{"Fecha":"2024-08-21","Lat":"46\u00b018,5'S","Lon":"75\u00b024,4'W","Msur":65.1,"Mcola":682.0,"Otros":18.5},"32":{"Fecha":"2024-08-22","Lat":"46\u00b027,6'S","Lon":"75\u00b039,2'W","Msur":67.1,"Mcola":117.0,"Otros":13.0},"33":{"Fecha":"2024-08-22","Lat":"46\u00b021,6'S","Lon":"75\u00b030,1'W","Msur":170.1,"Mcola":110.7,"Otros":19.7},"34":{"Fecha":"2024-08-22","Lat":"46\u00b058,8'S","Lon":"75\u00b036,6'W","Msur":191.2,"Mcola":47.1,"Otros":25.0},"35":{"Fecha":"2024-08-23","Lat":"46\u00b048,4'S","Lon":"75\u00b041,1'W","Msur":152.6,"Mcola":35.1,"Otros":0.9},"36":{"Fecha":"2024-08-23","Lat":"46\u00b034,7'S","Lon":"75\u00b039,5'W","Msur":135.9,"Mcola":641.0,"Otros":1.2}};


function updateLancePanel(lance){
  const data = lanceInfo[lance] || lanceInfo[String(lance)];
  if(!data) return;
  document.getElementById('metaFecha').textContent = data.Fecha;
  document.getElementById('metaLat').textContent = data.Lat;
  document.getElementById('metaLon').textContent = data.Lon;
  document.getElementById('kgMsur').textContent = data.Msur.toFixed(1);
  document.getElementById('kgMcola').textContent = data.Mcola.toFixed(1);
  document.getElementById('kgOtros').textContent = data.Otros.toFixed(1);
}

selector.addEventListener('click', e => {
  if(e.target.tagName === 'BUTTON') {
    const lance = e.target.dataset.lance;
    drawChart(lance);
    drawDonut(lance);
    updateLancePanel(lance);
    setActiveButton(lance);
  }
});

// Inicializar con primer lance
drawChart(lances[0]);
setActiveButton(lances[0]);

const dataMsur = {"1":[0,0,0,0,0,0,0,0,0,0,6,5,5,3,2,2,1,0,0,0,0,0,0],"2":[0,0,0,0,0,0,0,0,3,6,19,14,8,0,2,1,1,0,0,0,0,0,0],"3":[0,0,0,0,0,0,1,2,3,7,19,7,6,1,0,1,1,0,0,0,0,0,0],"4":[0,0,0,0,0,0,0,0,0,1,1,1,3,1,4,0,1,0,0,0,0,0,0],"5":[0,0,0,0,0,1,0,0,1,2,7,11,6,2,3,2,0,0,0,0,0,0,0],"6":[0,0,0,0,0,0,0,0,1,3,3,2,6,4,2,1,1,1,0,0,0,0,0],"7":[0,0,0,0,0,0,0,0,0,2,3,3,5,5,6,5,2,0,0,0,0,0,0],"8":[0,0,0,0,0,0,0,0,0,1,4,5,8,11,17,20,9,4,1,0,0,0,0],"9":[0,0,0,0,0,0,0,0,0,0,4,4,3,7,10,5,2,1,0,0,0,0,0],"10":[0,0,0,0,2,0,1,0,5,12,19,15,13,2,8,2,1,1,0,0,0,0,0],"11":[0,0,0,0,2,4,0,1,1,3,13,15,15,6,14,12,2,5,0,0,0,0,0],"12":[0,0,0,0,0,0,0,0,3,4,24,17,13,8,17,20,5,1,0,0,0,0,0],"13":[0,0,0,0,0,1,1,2,7,19,30,27,16,6,13,8,2,1,0,0,0,0,0],"14":[0,0,0,0,0,0,0,0,0,2,3,2,7,6,9,5,1,0,0,0,0,0,0],"15":[0,0,0,0,0,0,0,0,0,1,2,1,2,4,3,1,0,0,0,0,0,0,0],"16":[0,0,0,0,0,0,0,1,9,15,20,11,12,7,8,9,4,1,0,0,0,0,0],"17":[0,0,0,0,0,0,0,1,4,7,12,11,16,8,12,9,2,0,0,0,0,0,0],"18":[0,0,0,0,10,16,9,7,5,2,1,6,14,4,5,3,1,0,0,0,0,0,0],"19":[0,0,0,0,1,0,0,0,2,0,3,6,0,3,3,3,0,0,0,0,0,0,0],"20":[0,0,0,1,0,0,0,2,0,6,18,17,19,15,20,5,2,1,0,0,0,0,0],"21":[0,0,0,0,0,0,0,0,0,1,11,23,9,9,7,6,1,0,0,0,0,0,0],"22":[0,0,0,0,2,5,2,3,4,3,8,12,12,9,4,2,2,0,0,0,0,0,0],"23":[0,0,0,0,0,0,0,0,1,0,0,2,0,1,3,2,1,1,0,0,0,0,0],"24":[0,0,0,0,0,1,0,0,2,5,16,27,16,7,10,5,2,0,0,0,0,0,0],"25":[0,0,0,0,0,0,1,2,0,2,3,6,8,4,5,1,0,0,0,0,0,0,0],"26":[0,0,0,0,0,0,0,0,0,0,1,1,1,0,4,1,0,0,0,0,0,0,0],"27":[0,0,0,0,0,0,0,0,1,0,0,1,1,5,3,2,1,0,0,0,0,0,0],"28":[0,0,0,0,0,0,0,0,1,0,0,0,0,2,4,4,0,1,0,0,0,0,0],"29":[0,0,0,0,2,1,1,0,2,4,3,9,27,43,45,19,10,2,0,0,0,0,0],"30":[0,0,0,0,0,1,0,1,1,2,1,2,2,12,7,4,0,0,0,0,0,0,0],"31":[0,0,0,1,1,0,1,1,1,4,4,11,2,2,0,0,1,0,0,0,0,0,0],"32":[0,0,0,0,0,0,1,0,1,0,1,6,3,5,1,0,1,1,0,0,0,0,0],"33":[0,0,0,1,0,4,0,0,8,13,11,12,9,5,4,1,2,1,0,0,0,0,0],"34":[0,0,0,0,8,3,1,0,1,2,6,14,15,15,2,3,0,0,0,0,0,0,0],"35":[0,0,0,1,4,0,1,1,0,2,9,17,14,10,1,0,1,0,0,0,0,0,0],"36":[0,0,0,0,0,0,0,0,0,2,8,19,7,5,2,3,0,1,0,0,0,0,0]};

let chartMsur;
function drawMsur(lance) {
  const ctx = document.getElementById('chartMsur').getContext('2d');
  const data = dataMsur[lance];
  if(chartMsur) {
    chartMsur.data.datasets[0].data = data;
    chartMsur.options.plugins.title.text = 'Merluza del Sur – Lance ' + lance;
    chartMsur.update();
    return;
  }
  chartMsur = new Chart(ctx, {
    type: 'line',
    data: {
      labels: classes,
      datasets: [{
        label: 'Frecuencia',
        data: data,
        fill: false,
        tension: 0.3,
        borderWidth: 2,
        pointRadius: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true, position: 'top' },
        title: { display: true, text: 'Merluza del Sur – Lance ' + lance }
      },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'Frecuencia' } },
        x: { title: { display: true, text: 'Clase de Talla (cm)' } }
      }
    }
  });
}

// Modify existing selector click listener to trigger drawMsur

function updateInfoMsur(lance){
  const arr = dataMsur[lance] || dataMsur[String(lance)];
  if(!arr){ return; }
  const total = arr.reduce((a,b)=>a+b,0);
  const max = Math.max(...arr);
  const modeIdx = arr.indexOf(max);
  const moda = classes[modeIdx] ?? '–';
  const firstIdx = arr.findIndex(v=>v>0);
  const lastIdx = arr.length - 1 - [...arr].reverse().findIndex(v=>v>0);
  const rango = (firstIdx === -1) ? '–' : classes[firstIdx] + ' / ' + classes[lastIdx];
  document.getElementById('valModaS').textContent = moda;
  document.getElementById('valFrecS').textContent = max;
  document.getElementById('valRangoS').textContent = rango;
  document.getElementById('valTotalS').textContent = total;
}
document.getElementById('selector').addEventListener('click', e => {
  if(e.target.tagName === 'BUTTON') {
    const lance = e.target.dataset.lance;
    drawMsur(lance);
    drawDonut(lance);
    updateInfoMsur(lance);
    drawDonut(lance);
  }
});

// Initialize with first lance if available
if (lances && lances.length) {
  drawMsur(lances[0]);
  updateInfoMsur(lances[0]);
  drawDonut(lances[0]);
  updateLancePanel(lances[0]);
}
}

fetch('data.json')
  .then(r => r.json())
  .then(d => {
    lances = d.lances;
    classes = d.classes;
    dataByLance = d.dataByLance;
    dataMsur = d.dataMsur || {};
    dataCapt = d.dataCapt || {};
    lanceInfo = d.lanceInfo || {};
    coordsLance = d.coordsLance || {};
    initVITAC();
  })
  .catch(err => {
    console.error('No se pudo cargar data.json', err);
    // fallback: init with whatever is inline (if any)
    initVITAC();
  });
// --- End loader ---

</script>

<!-- MAP SCRIPT START -->
<script>
const coordsLance = {"1":[-43.513333333333335,-75.22166666666666],"2":[-43.691416666666676,-75.1095],"3":[-43.76808333333334,-75.03291666666668],"4":[-43.93925000000001,-75.249],"5":[-44.00633333333334,-75.23416666666667],"6":[-44.04433333333335,-75.12083333333334],"7":[-44.08833333333334,-74.94833333333334],"8":[-44.12741666666666,-74.99674999999999],"9":[-44.18858333333333,-74.89833333333334],"10":[-44.224500000000006,-75.10008333333334],"11":[-44.211666666666666,-74.85916666666667],"12":[-44.3175,-75.35333333333334],"13":[-44.41175,-75.33791666666667],"14":[-44.59074999999999,-75.37691666666667],"15":[-44.66224999999999,-75.35466666666667],"16":[-44.74625000000001,-75.506],"17":[-44.85958333333333,-75.53825],"18":[-45.007083333333334,-75.51058333333334],"19":[-45.33916666666667,-75.52916666666667],"20":[-45.298333333333325,-75.51833333333333],"21":[-45.210666666666675,-75.14791666666666],"22":[-45.13499999999999,-75.37833333333333],"23":[-45.3605,-75.06675],"24":[-45.16491666666668,-75.13783333333335],"25":[-45.06666666666667,-75.27833333333334],"26":[-45.48941666666666,-75.51025000000001],"27":[-45.5835,-75.52666666666667],"28":[-45.76625000000001,-75.56008333333332],"29":[-45.92166666666667,-75.5655],"30":[-46.14041666666667,-75.51083333333332],"31":[-46.30750000000001,-75.40583333333333],"32":[-46.460249999999995,-75.65408333333333],"33":[-46.35916666666667,-75.50166666666668],"34":[-46.979166666666664,-75.61016666666667],"35":[-46.80666666666666,-75.685],"36":[-46.57775,-75.65908333333333]};
let mapL, markerL;
function initMap() {
  mapL = L.map('mapLance').setView([-43,-75], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(mapL);
  markerL = L.marker([-43,-75]).addTo(mapL);
}
function showMapFor(l) {
  if(!mapL) initMap();
  const p=coordsLance[l]||coordsLance[String(l)];
  if(!p) return;
  markerL.setLatLng(p);
  mapL.setView(p, 7);
}
document.addEventListener('DOMContentLoaded', ()=> {
  if(typeof lances!=='undefined' && lances.length) showMapFor(lances[0]);
});
document.getElementById('selector').addEventListener('click', e=>{
  if(e.target.tagName==='BUTTON') showMapFor(e.target.dataset.lance);
});
</script>
<!-- MAP SCRIPT END -->
</body>
</html>
